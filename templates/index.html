<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Timetable Converter</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface2: #334155;
            --border: #475569;
            --text: #f1f5f9;
            --text2: #94a3b8;
            --accent: #38bdf8;
            --accent2: #818cf8;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --gold: #f59e0b;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ---- Header ---- */
        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            text-align: center;
        }
        header h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--gold), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        header p {
            color: var(--text2);
            margin-top: 0.3rem;
            font-size: 0.95rem;
        }

        /* ---- Container ---- */
        .container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        /* ---- Upload Zone ---- */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--surface);
            position: relative;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(56, 189, 248, 0.05);
        }
        .upload-zone .icon { font-size: 3rem; margin-bottom: 1rem; }
        .upload-zone h3 { font-size: 1.3rem; margin-bottom: 0.5rem; }
        .upload-zone p { color: var(--text2); font-size: 0.9rem; }
        .upload-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* ---- Progress Bar ---- */
        .progress-container {
            display: none;
            margin-top: 1.5rem;
        }
        .progress-bar {
            height: 6px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        .progress-text {
            text-align: center;
            color: var(--text2);
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        /* ---- Alerts ---- */
        .alert {
            padding: 1rem 1.2rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            font-size: 0.9rem;
            display: none;
        }
        .alert.error { background: rgba(248,113,113,0.15); border: 1px solid var(--danger); color: var(--danger); }
        .alert.success { background: rgba(74,222,128,0.15); border: 1px solid var(--success); color: var(--success); }
        .alert.warning { background: rgba(251,191,36,0.15); border: 1px solid var(--warning); color: var(--warning); }

        /* ---- Stats Row ---- */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 1.2rem;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
        }
        .stat-card .label {
            color: var(--text2);
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }

        /* ---- Sections ---- */
        .section {
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin: 1.5rem 0;
            overflow: hidden;
        }
        .section-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ---- Table ---- */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .schedule-table th {
            background: var(--surface2);
            padding: 0.8rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .schedule-table td {
            padding: 0.7rem 1rem;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .schedule-table tr:hover td {
            background: rgba(56, 189, 248, 0.03);
        }
        .schedule-table .editable {
            cursor: text;
            border-bottom: 1px dashed var(--border);
            min-width: 60px;
            display: inline-block;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .schedule-table .editable:focus {
            outline: 2px solid var(--accent);
            background: var(--surface2);
        }
        .time-input {
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.85rem;
            font-family: inherit;
            width: 90px;
            cursor: pointer;
        }
        .time-input:focus {
            outline: 2px solid var(--accent);
            border-color: var(--accent);
        }
        .time-input:hover {
            border-color: var(--accent);
        }
        .time-changed {
            border-color: var(--warning) !important;
            box-shadow: 0 0 0 1px var(--warning);
        }
        .warning-banner {
            background: rgba(251,191,36,0.12);
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            padding: 0.9rem 1.2rem;
            margin: 1rem 0;
            color: var(--warning);
            font-size: 0.88rem;
            line-height: 1.5;
        }
        .warning-banner strong { color: #fcd34d; }
        .reconvert-bar {
            background: rgba(56,189,248,0.08);
            border: 1px solid var(--accent);
            border-radius: var(--radius);
            padding: 0.8rem 1.2rem;
            margin: 1rem 0;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .reconvert-bar .info {
            color: var(--accent);
            font-size: 0.88rem;
        }
        .reconvert-bar .info strong { color: var(--text); }
        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .confidence-high { background: rgba(74,222,128,0.2); color: var(--success); }
        .confidence-med { background: rgba(251,191,36,0.2); color: var(--warning); }
        .confidence-low { background: rgba(248,113,113,0.2); color: var(--danger); }

        .mapping-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .mapping-exact { background: rgba(74,222,128,0.2); color: var(--success); }
        .mapping-fuzzy { background: rgba(251,191,36,0.2); color: var(--warning); }
        .mapping-unmatched { background: rgba(248,113,113,0.2); color: var(--danger); }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: #0f172a; }
        .btn-primary:hover:not(:disabled) { background: #7dd3fc; }
        .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { background: var(--border); }
        .btn-success { background: var(--success); color: #0f172a; }
        .btn-success:hover:not(:disabled) { background: #86efac; }
        .btn-warning { background: var(--gold); color: #0f172a; }
        .btn-warning:hover:not(:disabled) { background: #fbbf24; }

        .btn-group {
            display: flex;
            gap: 0.7rem;
            flex-wrap: wrap;
            padding: 1rem 1.5rem;
        }

        /* ---- Footer ---- */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text2);
            font-size: 0.8rem;
        }

        /* ---- Responsive ---- */
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            header h1 { font-size: 1.4rem; }
            .upload-zone { padding: 2rem 1rem; }
            .schedule-table { font-size: 0.8rem; }
            .schedule-table th, .schedule-table td { padding: 0.5rem; }
            .btn-group { flex-direction: column; }
        }

        /* ---- Hidden ---- */
        .hidden { display: none !important; }

        /* ---- Scroll for table ---- */
        .table-wrapper { overflow-x: auto; }

        /* ---- Spinner ---- */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.4rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ---- Modal ---- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }
        .modal h3 { margin-bottom: 1rem; }
        .modal .btn-group { padding: 1rem 0 0; justify-content: flex-end; }
    </style>
</head>
<body>

<header>
    <h1>&#9770; Ramadan Timetable Converter</h1>
    <p>Upload your timetable &bull; Get Ramadan timing instantly &bull; Sync to Google Calendar</p>
</header>

<div class="container">
    <!-- Upload -->
    <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept="image/*,.pdf">
        <div class="icon">&#128247;</div>
        <h3>Drop your timetable here</h3>
        <p>Supports photos, screenshots, and PDFs &bull; Max 20 MB</p>
    </div>

    <!-- Progress -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar"><div class="fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">Uploading...</div>
    </div>

    <!-- Alerts -->
    <div class="alert error" id="alertError"></div>
    <div class="alert success" id="alertSuccess"></div>
    <div class="alert warning" id="alertWarning"></div>

    <!-- Results -->
    <div id="resultsSection" class="hidden">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="value" id="statClasses">0</div>
                <div class="label">Classes Found</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statConfidence">0%</div>
                <div class="label">Avg Confidence</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statExact">0</div>
                <div class="label">Exact Matches</div>
            </div>
            <div class="stat-card">
                <div class="value" id="statConflicts">0</div>
                <div class="label">Conflicts</div>
            </div>
        </div>

        <!-- Time Warning -->
        <div class="warning-banner" id="timeWarningBanner" style="display:none;">
            &#9888;&#65039; <strong>Heads up:</strong> The AI may confuse <strong>:00</strong> and <strong>:30</strong> boundaries
            (e.g., reading 9:00 instead of 9:30). Please double-check the start/end times below and
            edit them if needed — the Ramadan schedule will update automatically.
        </div>

        <!-- Original Schedule -->
        <div class="section">
            <div class="section-header">
                <h2>&#128203; Original Schedule <small style="font-size:0.7rem;color:var(--text2);font-weight:400;">&#9998; click times to edit</small></h2>
            </div>
            <div class="table-wrapper">
                <table class="schedule-table" id="originalTable">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Course</th>
                            <th>Start &#9998;</th>
                            <th>End &#9998;</th>
                            <th>Duration</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Re-convert bar -->
        <div class="reconvert-bar" id="reconvertBar">
            <div class="info">&#9998; <strong id="changedCount">0</strong> time(s) changed — click Re-convert to update Ramadan schedule</div>
            <button class="btn btn-primary" onclick="reconvertSchedule()">&#128260; Re-convert</button>
        </div>

        <!-- Ramadan Schedule -->
        <div class="section">
            <div class="section-header">
                <h2>&#9770; Ramadan Schedule</h2>
                <button class="btn btn-secondary" onclick="saveEdits()">
                    &#128190; Save Edits
                </button>
            </div>
            <div class="table-wrapper">
                <table class="schedule-table" id="ramadanTable">
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Course</th>
                            <th>Original</th>
                            <th>Ramadan Start</th>
                            <th>Ramadan End</th>
                            <th>Duration</th>
                            <th>Mapping</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="exportJSON()">
                    &#128196; Export JSON
                </button>
                <button class="btn btn-primary" onclick="exportCSV()">
                    &#128202; Export CSV
                </button>
                <button class="btn btn-success" onclick="downloadCalendar()">
                    &#128197; Download Calendar (.ics)
                </button>
                <button class="btn btn-warning" onclick="resetApp()">
                    &#128260; Upload New
                </button>
            </div>
        </div>

        <!-- Warnings -->
        <div class="section hidden" id="warningsSection">
            <div class="section-header">
                <h2>&#9888;&#65039; Warnings</h2>
            </div>
            <div id="warningsList" style="padding: 1rem 1.5rem;"></div>
        </div>
    </div>
</div>

<footer>
    Ramadan Timetable Converter &bull; 2026
</footer>

<script>
// =========================================================================
// State
// =========================================================================
let sessionId = null;
let originalData = null;
let ramadanData = null;
let pendingChanges = 0;

// =========================================================================
// Client-side Ramadan Lookup Tables (official university timings)
// =========================================================================
const MT_LOOKUP = {
    // 1-hour slots (:30 boundaries)
    '08:30-09:30':'08:30-09:10','09:30-10:30':'09:10-09:50','10:30-11:30':'09:50-10:30',
    '11:30-12:30':'10:30-11:10','12:30-13:30':'11:10-11:50','13:30-14:30':'11:50-12:30',
    '14:30-15:30':'12:30-13:10','15:30-16:30':'13:10-13:50','16:30-17:30':'13:50-14:30',
    '17:30-18:30':'14:30-15:10','18:30-19:30':'15:10-15:50','19:30-20:30':'15:50-16:30',
    '20:30-21:30':'16:30-17:10',
    // 1-hour slots (:00 boundaries)
    '09:00-10:00':'08:50-09:30','10:00-11:00':'09:30-10:10','11:00-12:00':'10:10-10:50',
    '12:00-13:00':'10:50-11:30','13:00-14:00':'11:30-12:10','14:00-15:00':'12:10-12:50',
    '15:00-16:00':'12:50-13:30','16:00-17:00':'13:30-14:10','17:00-18:00':'14:10-14:50',
    '18:00-19:00':'14:50-15:30','19:00-20:00':'15:30-16:10','20:00-21:00':'16:10-16:50',
    '21:00-22:00':'16:50-17:30',
    // 1.5-hour (90 min) slots
    '08:00-09:30':'08:00-09:00','09:30-11:00':'09:10-10:10','11:00-12:30':'10:10-11:10',
    '13:30-15:00':'11:50-12:50','15:00-16:30':'12:50-13:50','16:30-18:00':'13:50-14:50',
    '18:00-19:30':'14:50-15:50','19:30-21:00':'15:50-16:50','21:00-22:30':'16:50-17:50',
    // 2-hour slots (:30 boundaries)
    '08:30-10:30':'08:30-09:50','10:30-12:30':'09:50-11:10','12:30-14:30':'11:10-12:30',
    '14:30-16:30':'12:30-13:50','16:30-18:30':'13:50-15:10','18:30-20:30':'15:10-16:30',
    '20:30-22:30':'16:30-17:50',
};

const FRI_LOOKUP = {
    '08:00-09:00':'08:00-08:40','08:00-10:00':'08:00-09:20','08:00-12:00':'08:00-10:40',
    '08:30-12:00':'08:30-10:50','09:00-12:00':'08:40-10:40','10:00-12:00':'09:20-10:40',
    '14:00-15:00':'10:40-11:20','14:00-16:00':'10:40-12:00','14:00-17:00':'14:00-16:00',
    '14:00-18:00':'14:00-16:40','14:00-19:00':'14:00-17:20','14:30-16:30':'14:00-15:20',
    '15:00-16:00':'14:00-14:40','15:00-17:00':'14:00-15:20','15:00-18:00':'14:00-16:00',
    '15:00-19:00':'14:00-16:40','16:00-18:00':'14:40-16:00','16:00-19:00':'14:40-16:40',
    '16:30-18:30':'15:20-16:40','17:30-20:30':'15:30-17:30','18:00-19:00':'16:40-17:20',
    '18:00-20:00':'16:00-17:20','18:00-21:00':'16:00-18:00','18:30-20:30':'16:00-17:20',
    '19:00-20:00':'16:40-17:20',
};

function toMin(t) { const p = t.split(':'); return parseInt(p[0])*60+parseInt(p[1]); }

function clientConvert(classes) {
    const result = [];
    let exact = 0, fuzzy = 0, unmatched = 0;
    for (const cls of classes) {
        const s = cls.start_time, e = cls.end_time;
        const day = cls.day || '';
        const key = s + '-' + e;
        const lookup = (day === 'Friday') ? FRI_LOOKUP : MT_LOOKUP;
        const lookupRef = (day === 'Friday') ? FRI_LOOKUP : MT_LOOKUP;

        if (lookup[key]) {
            const [rs, re] = lookup[key].split('-');
            result.push({...cls, original_start:s, original_end:e, ramadan_start:rs, ramadan_end:re,
                duration_minutes: toMin(re)-toMin(rs), mapping_type:'exact'});
            exact++;
        } else {
            // Fuzzy: find nearest slot
            const sMin = toMin(s), eMin = toMin(e);
            let best = null, bestDist = Infinity;
            for (const k in lookupRef) {
                const [ks, ke] = k.split('-');
                const dist = Math.abs(toMin(ks)-sMin) + Math.abs(toMin(ke)-eMin);
                if (dist < bestDist) { bestDist = dist; best = {k, v: lookupRef[k]}; }
            }
            if (best && bestDist <= 35) {
                const [rs, re] = best.v.split('-');
                result.push({...cls, original_start:s, original_end:e, ramadan_start:rs, ramadan_end:re,
                    duration_minutes: toMin(re)-toMin(rs), mapping_type:'fuzzy',
                    fuzzy_matched_from: best.k});
                fuzzy++;
            } else {
                result.push({...cls, original_start:s, original_end:e, ramadan_start:s, ramadan_end:e,
                    mapping_type:'unmatched', warning:'No Ramadan mapping found.'});
                unmatched++;
            }
        }
    }
    return {
        classes: result,
        total_classes: result.length,
        conversion_stats: {exact_matches: exact, fuzzy_matches: fuzzy, unmatched},
    };
}

// =========================================================================
// DOM Refs
// =========================================================================
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const alertError = document.getElementById('alertError');
const alertSuccess = document.getElementById('alertSuccess');
const alertWarning = document.getElementById('alertWarning');
const resultsSection = document.getElementById('resultsSection');

// =========================================================================
// Upload Handling
// =========================================================================

// Drag & Drop
uploadZone.addEventListener('dragover', e => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', e => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        handleFile(fileInput.files[0]);
    }
});

function handleFile(file) {
    hideAlerts();

    // Validate
    const maxSize = 20 * 1024 * 1024;
    if (file.size > maxSize) {
        showAlert('error', 'File too large. Maximum size is 20 MB.');
        return;
    }

    const allowed = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/bmp', 'application/pdf'];
    if (!allowed.includes(file.type)) {
        showAlert('error', `Unsupported file type: ${file.type}`);
        return;
    }

    uploadFile(file);
}

async function uploadFile(file) {
    showProgress('Uploading timetable...', 10);

    const formData = new FormData();
    formData.append('file', file);

    try {
        showProgress('Processing image...', 30);

        const resp = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
        });

        showProgress('Extracting schedule...', 60);

        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.detail || 'Upload failed');
        }

        showProgress('Converting to Ramadan timing...', 85);

        const data = await resp.json();

        showProgress('Done!', 100);

        if (data.success) {
            sessionId = data.session_id;
            originalData = data.original_schedule;
            ramadanData = data.ramadan_schedule;
            renderResults();
            showAlert('success', `Successfully extracted ${data.original_schedule.total_classes} classes!`);
        } else {
            throw new Error('Processing returned no results');
        }
    } catch (err) {
        showAlert('error', err.message);
        hideProgress();
    }
}

// =========================================================================
// Render Results
// =========================================================================

function renderResults() {
    hideProgress();
    uploadZone.classList.add('hidden');
    resultsSection.classList.remove('hidden');
    pendingChanges = 0;
    document.getElementById('reconvertBar').style.display = 'none';

    // Show time warning
    document.getElementById('timeWarningBanner').style.display = 'block';

    // Stats
    document.getElementById('statClasses').textContent = originalData.total_classes;
    document.getElementById('statConfidence').textContent =
        Math.round((originalData.average_confidence || 0) * 100) + '%';
    document.getElementById('statExact').textContent =
        ramadanData.conversion_stats?.exact_matches || 0;
    document.getElementById('statConflicts').textContent =
        (originalData.conflicts || []).length;

    // Original table
    renderOriginalTable();

    // Ramadan table
    renderRamadanTable();

    // Warnings
    renderWarnings();
}

function renderOriginalTable() {
    const tbody = document.querySelector('#originalTable tbody');
    tbody.innerHTML = '';

    for (let i = 0; i < (originalData.classes || []).length; i++) {
        const cls = originalData.classes[i];
        const conf = cls.confidence || 0;
        const confClass = conf >= 0.7 ? 'high' : conf >= 0.5 ? 'med' : 'low';
        const dur = cls.duration_minutes || '?';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${esc(cls.day)}</td>
            <td>${esc(cls.course)}</td>
            <td>
                <input type="time" class="time-input" value="${esc(cls.start_time)}" data-idx="${i}" data-field="start_time" data-orig="${esc(cls.start_time)}" step="1800">
                <small style="color:var(--text2);display:block;margin-top:2px">${to12h(cls.start_time)}</small>
            </td>
            <td>
                <input type="time" class="time-input" value="${esc(cls.end_time)}" data-idx="${i}" data-field="end_time" data-orig="${esc(cls.end_time)}" step="1800">
                <small style="color:var(--text2);display:block;margin-top:2px">${to12h(cls.end_time)}</small>
            </td>
            <td class="dur-cell">${dur} min</td>
            <td><span class="confidence-badge confidence-${confClass}">${Math.round(conf*100)}%</span></td>
        `;
        tbody.appendChild(tr);
    }

    // Attach change listeners to all time inputs
    document.querySelectorAll('#originalTable .time-input').forEach(inp => {
        inp.addEventListener('change', onTimeInputChange);
    });
}

function onTimeInputChange(e) {
    const inp = e.target;
    const idx = parseInt(inp.dataset.idx);
    const field = inp.dataset.field;
    const orig = inp.dataset.orig;
    const newVal = inp.value;

    // Update the 12h label below
    const small = inp.parentElement.querySelector('small');
    if (small) small.textContent = to12h(newVal);

    // Highlight changed inputs
    if (newVal !== orig) {
        inp.classList.add('time-changed');
    } else {
        inp.classList.remove('time-changed');
    }

    // Update duration display
    const row = inp.closest('tr');
    const startInp = row.querySelector('[data-field="start_time"]');
    const endInp = row.querySelector('[data-field="end_time"]');
    if (startInp && endInp) {
        const durMin = toMin(endInp.value) - toMin(startInp.value);
        const durCell = row.querySelector('.dur-cell');
        if (durCell) durCell.textContent = (durMin > 0 ? durMin : '?') + ' min';
    }

    // Count total changes
    pendingChanges = document.querySelectorAll('#originalTable .time-input.time-changed').length;
    const bar = document.getElementById('reconvertBar');
    if (pendingChanges > 0) {
        bar.style.display = 'flex';
        document.getElementById('changedCount').textContent = pendingChanges;
    } else {
        bar.style.display = 'none';
    }
}

function reconvertSchedule() {
    // Gather updated classes from the original table inputs
    const classes = JSON.parse(JSON.stringify(originalData.classes));
    document.querySelectorAll('#originalTable .time-input').forEach(inp => {
        const idx = parseInt(inp.dataset.idx);
        const field = inp.dataset.field;
        classes[idx][field] = inp.value;
        // Update the stored data-orig so future edits track correctly
        inp.dataset.orig = inp.value;
        inp.classList.remove('time-changed');
    });

    // Update originalData
    originalData.classes = classes;

    // Re-run conversion client-side
    ramadanData = clientConvert(classes);

    // Update UI
    renderRamadanTable();
    document.getElementById('statExact').textContent =
        ramadanData.conversion_stats?.exact_matches || 0;

    pendingChanges = 0;
    document.getElementById('reconvertBar').style.display = 'none';
    showAlert('success', 'Schedule re-converted with your corrected times!');
    renderWarnings();
}

function renderRamadanTable() {
    const tbody = document.querySelector('#ramadanTable tbody');
    tbody.innerHTML = '';

    for (let i = 0; i < (ramadanData.classes || []).length; i++) {
        const cls = ramadanData.classes[i];
        const mt = cls.mapping_type || 'unmatched';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="editable" contenteditable="true" data-idx="${i}" data-field="day">${esc(cls.day)}</span></td>
            <td><span class="editable" contenteditable="true" data-idx="${i}" data-field="course">${esc(cls.course)}</span></td>
            <td>${esc(cls.original_start)} - ${esc(cls.original_end)}<br><small style="color:var(--text2)">${to12h(cls.original_start)} - ${to12h(cls.original_end)}</small></td>
            <td><span class="editable" contenteditable="true" data-idx="${i}" data-field="ramadan_start">${esc(cls.ramadan_start)}</span> <small style="color:var(--text2)">(${to12h(cls.ramadan_start)})</small></td>
            <td><span class="editable" contenteditable="true" data-idx="${i}" data-field="ramadan_end">${esc(cls.ramadan_end)}</span> <small style="color:var(--text2)">(${to12h(cls.ramadan_end)})</small></td>
            <td>${cls.duration_minutes || '?'} min</td>
            <td><span class="mapping-badge mapping-${mt}">${mt}</span></td>
        `;
        tbody.appendChild(tr);
    }
}

function renderWarnings() {
    const allWarnings = [
        ...(originalData.warnings || []),
        ...(ramadanData.warnings || []),
    ];

    const section = document.getElementById('warningsSection');
    const list = document.getElementById('warningsList');

    if (allWarnings.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');
    list.innerHTML = allWarnings.map(w =>
        `<div style="padding: 0.4rem 0; color: var(--warning);">&#9888;&#65039; ${esc(w)}</div>`
    ).join('');
}

// =========================================================================
// Actions
// =========================================================================

async function saveEdits() {
    const editables = document.querySelectorAll('#ramadanTable .editable');
    let classes = JSON.parse(JSON.stringify(ramadanData.classes));

    editables.forEach(el => {
        const idx = parseInt(el.dataset.idx);
        const field = el.dataset.field;
        classes[idx][field] = el.textContent.trim();
    });

    try {
        const resp = await fetch('/api/update-schedule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_id: sessionId, classes}),
        });
        const data = await resp.json();
        if (data.success) {
            ramadanData = data.ramadan_schedule;
            renderRamadanTable();
            showAlert('success', 'Schedule updated successfully!');
        }
    } catch (err) {
        showAlert('error', 'Failed to save edits: ' + err.message);
    }
}

function exportJSON() {
    if (!ramadanData) return;
    const blob = new Blob([JSON.stringify(ramadanData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ramadan_schedule.json';
    a.click();
    URL.revokeObjectURL(url);
}

function exportCSV() {
    if (!ramadanData) return;
    const rows = [['Day','Course','Original Start','Original End','Ramadan Start','Ramadan End','Duration (min)']];
    for (const c of ramadanData.classes || []) {
        rows.push([c.day, c.course, c.original_start, c.original_end, c.ramadan_start, c.ramadan_end, c.duration_minutes]);
    }
    const csv = rows.map(r => r.map(v => '"'+(v||'')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ramadan_schedule.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function downloadCalendar() {
    if (!ramadanData) return;

    const tz = 'Asia/Dubai';
    const ramadanEnd = '20260318';  // End of Ramadan 2026 UAE
    const dayOffsets = {Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6,Sunday:0};

    const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Ramadan Timetable Converter//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        'X-WR-TIMEZONE:' + tz,
    ];

    const now = new Date();
    const stamp = now.toISOString().replace(/[-:]/g,'').replace(/\.\d+/,'');
    let uid = 0;

    for (const cls of ramadanData.classes || []) {
        const day = cls.day || '';
        const course = cls.course || 'Class';
        const ramStart = cls.ramadan_start || '';
        const ramEnd = cls.ramadan_end || '';
        const origStart = cls.original_start || '';
        const origEnd = cls.original_end || '';

        if (!day || !ramStart || !ramEnd) continue;

        const targetDay = dayOffsets[day];
        if (targetDay === undefined) continue;

        // Find next occurrence of this weekday
        const currentDay = now.getDay(); // 0=Sun
        let diff = targetDay - currentDay;
        if (diff < 0) diff += 7;
        if (diff === 0) diff = 7; // schedule starts next week
        const nextDate = new Date(now);
        nextDate.setDate(now.getDate() + diff);
        // Use local date parts to avoid UTC shift
        const yy = nextDate.getFullYear();
        const mm = String(nextDate.getMonth()+1).padStart(2,'0');
        const dd = String(nextDate.getDate()).padStart(2,'0');
        const dateStr = yy + mm + dd;

        const startIcs = ramStart.replace(':','') + '00';
        const endIcs = ramEnd.replace(':','') + '00';
        uid++;

        lines.push(
            'BEGIN:VEVENT',
            'UID:ramadan-' + uid + '-' + Date.now() + '@timetable',
            'DTSTAMP:' + stamp,
            'DTSTART;TZID=' + tz + ':' + dateStr + 'T' + startIcs,
            'DTEND;TZID=' + tz + ':' + dateStr + 'T' + endIcs,
            'RRULE:FREQ=WEEKLY;UNTIL=' + ramadanEnd + 'T235959Z',
            'SUMMARY:[Ramadan] ' + course,
            'DESCRIPTION:Original: ' + origStart + '-' + origEnd + ' | Ramadan: ' + ramStart + '-' + ramEnd,
            'STATUS:CONFIRMED',
            'BEGIN:VALARM',
            'TRIGGER:-PT15M',
            'ACTION:DISPLAY',
            'DESCRIPTION:Reminder: ' + course + ' in 15 minutes',
            'END:VALARM',
            'END:VEVENT'
        );
    }

    lines.push('END:VCALENDAR');
    const ics = lines.join('\r\n');
    const blob = new Blob([ics], {type: 'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ramadan_schedule.ics';
    a.click();
    URL.revokeObjectURL(url);
    showAlert('success', 'Calendar file downloaded! Open it or import it into Google Calendar, Outlook, or Apple Calendar.');
}

function resetApp() {
    sessionId = null;
    originalData = null;
    ramadanData = null;
    pendingChanges = 0;
    resultsSection.classList.add('hidden');
    uploadZone.classList.remove('hidden');
    fileInput.value = '';
    document.getElementById('timeWarningBanner').style.display = 'none';
    document.getElementById('reconvertBar').style.display = 'none';
    hideAlerts();
}

// =========================================================================
// Helpers
// =========================================================================

function to12h(time24) {
    if (!time24 || !time24.includes(':')) return time24 || '';
    const parts = time24.split(':');
    let h = parseInt(parts[0], 10);
    const m = parts[1];
    const ampm = h >= 12 ? 'PM' : 'AM';
    if (h === 0) h = 12;
    else if (h > 12) h -= 12;
    return h + ':' + m + ' ' + ampm;
}

function showAlert(type, msg) {
    hideAlerts();
    const el = type === 'error' ? alertError :
               type === 'success' ? alertSuccess : alertWarning;
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 8000);
}

function hideAlerts() {
    alertError.style.display = 'none';
    alertSuccess.style.display = 'none';
    alertWarning.style.display = 'none';
}

function showProgress(text, pct) {
    progressContainer.style.display = 'block';
    progressFill.style.width = pct + '%';
    progressText.textContent = text;
}

function hideProgress() {
    setTimeout(() => {
        progressContainer.style.display = 'none';
        progressFill.style.width = '0%';
    }, 500);
}

function esc(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

// Check for callback redirect
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('calendar') === 'connected') {
    showAlert('success', 'Google Calendar connected! You can now sync your schedule.');
}
</script>

</body>
</html>
